<%- contentFor('html_attribute') %>
<%- contentFor('extra_css') %>
<%- contentFor('body_attribute') %>
<%- contentFor('content') %>

<div class="container-fluid">
    <!-- Page Title -->
    <div class="py-3 d-flex align-items-sm-center flex-sm-row flex-column">
        <div class="flex-grow-1">
            <div class="d-flex align-items-center">
                <div id="back-button-container" style="display: none;">
                    <a href="javascript:history.back()" class="btn btn-outline-secondary me-3">
                        <i class="mdi mdi-arrow-left"></i> Back
                    </a>
                </div>
                <div>
                    <h4 class="fs-18 fw-semibold m-0">Competitor Analysis</h4>
                    <p class="text-muted mb-0" id="projectContext">Analyze competition and market positioning</p>
                </div>
            </div>
        </div>
        <div class="text-end">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCompetitorModal">
                <i class="mdi mdi-plus me-2"></i>Add Competitor
            </button>
            <button class="btn btn-secondary ms-2" onclick="exportCompetitorData()">
                <i class="mdi mdi-download me-2"></i>Export
            </button>
        </div>
    </div>

    <!-- Competitor Analysis Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <!-- Filters -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <select class="form-select" id="marketFilter">
                                <option value="">All Markets</option>
                                <option value="E-commerce">E-commerce</option>
                                <option value="SaaS">SaaS</option>
                                <option value="Retail">Retail</option>
                                <option value="Services">Services</option>
                                <option value="Manufacturing">Manufacturing</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="levelFilter">
                                <option value="">All Competition Levels</option>
                                <option value="Direct">Direct</option>
                                <option value="Indirect">Indirect</option>
                                <option value="Substitute">Substitute</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="threatFilter">
                                <option value="">All Threat Levels</option>
                                <option value="High">High</option>
                                <option value="Medium">Medium</option>
                                <option value="Low">Low</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="searchCompetitors" placeholder="Search competitors...">
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover" id="competitorsTable">
                            <thead class="table-light">
                                <tr>
                                    <th width="5%">
                                        <input type="checkbox" id="selectAll" class="form-check-input">
                                    </th>
                                    <th width="20%">Competitor</th>
                                    <th width="15%">Market</th>
                                    <th width="12%">Competition Level</th>
                                    <th width="12%">Threat Level</th>
                                    <th width="15%">Strengths</th>
                                    <th width="11%">Website</th>
                                    <th width="10%">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="competitorsTableBody">
                                <tr>
                                    <td colspan="8" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2">Loading competitors...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Bulk Actions -->
                    <div class="d-none" id="bulkActions">
                        <div class="bg-light p-3 rounded mb-3">
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-warning" onclick="bulkUpdateThreat('High')">
                                    <i class="mdi mdi-alert me-1"></i>Mark High Threat
                                </button>
                                <button class="btn btn-sm btn-info" onclick="bulkExportCompetitors()">
                                    <i class="mdi mdi-download me-1"></i>Export Selected
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="bulkDeleteCompetitors()">
                                    <i class="mdi mdi-delete me-1"></i>Delete Selected
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Competitor Modal -->
<div class="modal fade" id="addCompetitorModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Competitor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addCompetitorForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Competitor Name *</label>
                            <input type="text" class="form-control" name="competitor_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Website</label>
                            <input type="url" class="form-control" name="website" placeholder="https://example.com">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Market</label>
                            <select class="form-select" name="industry">
                                <option value="E-commerce">E-commerce</option>
                                <option value="SaaS">SaaS</option>
                                <option value="Retail">Retail</option>
                                <option value="Services">Services</option>
                                <option value="Manufacturing">Manufacturing</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Competition Level</label>
                            <select class="form-select" name="market_position">
                                <option value="Direct">Direct</option>
                                <option value="Indirect">Indirect</option>
                                <option value="Substitute">Substitute</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Threat Level</label>
                            <select class="form-select" name="threat_level">
                                <option value="Low">Low</option>
                                <option value="Medium" selected>Medium</option>
                                <option value="High">High</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Products/Focus</label>
                            <textarea class="form-control" name="target_audience" rows="2" placeholder="Who is their target audience?"></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Target Market</label>
                            <textarea class="form-control" name="target_market" rows="2" placeholder="Who is their target audience?"></textarea>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Strengths</label>
                            <textarea class="form-control" name="strengths" rows="3" placeholder="What are they good at?"></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Weaknesses</label>
                            <textarea class="form-control" name="weaknesses" rows="3" placeholder="What are their weak points?"></textarea>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Pricing Strategy</label>
                            <textarea class="form-control" name="pricing_model" rows="2" placeholder="How do they price their products?"></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Marketing Strategy</label>
                            <textarea class="form-control" name="marketing_channels" rows="2" placeholder="How do they market themselves?"></textarea>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Traffic Estimate</label>
                            <input type="text" class="form-control" name="traffic_estimate" placeholder="e.g., 100K monthly visitors">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Revenue Estimate</label>
                            <input type="text" class="form-control" name="revenue_estimate" placeholder="e.g., $1M ARR">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Additional Notes</label>
                        <textarea class="form-control" name="notes" rows="3" placeholder="Any other observations or notes..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <span id="addCompetitorBtnText">Add Competitor</span>
                        <span id="addCompetitorSpinner" class="spinner-border spinner-border-sm d-none ms-2"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Competitor Modal -->
<div class="modal fade" id="deleteCompetitorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Competitor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong id="deleteCompetitorName"></strong>?</p>
                <p class="text-muted small">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteCompetitor()">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
let projectId;
let allCompetitors = [];

// Get project ID from URL
function getProjectIdFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('id');
}

// Load competitors from API
async function loadCompetitors() {
    try {
        showLoadingState();
        
        const response = await fetch(`/api/projects/${projectId}/competitors`);
        if (response.ok) {
            const competitors = await response.json();
            allCompetitors = competitors;
            
            renderCompetitors(competitors);
            updateBulkActions();
            
            console.log('✅ Competitors loaded:', competitors.length);
        } else {
            throw new Error('Failed to load competitors');
        }
    } catch (error) {
        console.error('Error loading competitors:', error);
        showErrorState('Failed to load competitors');
    }
}

// Show loading state
function showLoadingState() {
    const tbody = document.getElementById('competitorsTableBody');
    tbody.innerHTML = `
        <tr>
            <td colspan="8" class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading competitors...</p>
            </td>
        </tr>
    `;
}

// Show error state
function showErrorState(message) {
    const tbody = document.getElementById('competitorsTableBody');
    tbody.innerHTML = `
        <tr>
            <td colspan="8" class="text-center py-4">
                <i class="mdi mdi-alert-circle fs-48 text-muted"></i>
                <h5 class="mt-3">Error</h5>
                <p class="text-muted">${message}</p>
                <button class="btn btn-primary" onclick="loadCompetitors()">
                    <i class="mdi mdi-refresh me-2"></i>Retry
                </button>
            </td>
        </tr>
    `;
}

// Render competitors table
function renderCompetitors(competitors) {
    const tbody = document.getElementById('competitorsTableBody');
    
    if (competitors.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4">
                    <i class="mdi mdi-chart-line fs-48 text-muted"></i>
                    <h5 class="mt-3">No Competitors Yet</h5>
                    <p class="text-muted">Add your first competitor analysis</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCompetitorModal">
                        <i class="mdi mdi-plus me-2"></i>Add Competitor
                    </button>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = competitors.map(competitor => `
        <tr data-id="${competitor.id}">
            <td>
                <input type="checkbox" class="form-check-input competitor-checkbox" value="${competitor.id}">
            </td>
            <td>
                <div class="d-flex align-items-center">
                    <div class="competitor-icon me-2">
                        <i class="mdi mdi-domain fs-24 text-primary"></i>
                    </div>
                    <div>
                        <span class="fw-semibold">${competitor.competitor_name}</span>
                        <div class="text-muted small">${competitor.target_audience ? competitor.target_audience.substring(0, 50) + '...' : ''}</div>
                    </div>
                </div>
            </td>
            <td>
                <span class="badge bg-secondary">${competitor.industry || ''}</span>
            </td>
            <td>
                <span class="badge ${getLevelBadge(competitor.market_position)}">${competitor.market_position || ''}</span>
            </td>
            <td>
                <span class="badge ${getThreatBadge(competitor.threat_level)}">${competitor.threat_level || ''}</span>
            </td>
            <td>
                <span class="text-truncate d-inline-block" style="max-width: 150px;" title="${competitor.strengths || ''}">${competitor.strengths || ''}</span>
            </td>
            <td>
                ${competitor.website ? `<a href="${competitor.website}" target="_blank" class="btn btn-sm btn-outline-primary">Visit</a>` : ''}
            </td>
            <td>
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="mdi mdi-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="editCompetitor('${competitor.id}')">
                            <i class="mdi mdi-pencil me-2"></i>Edit
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="viewCompetitorDetails('${competitor.id}')">
                            <i class="mdi mdi-eye me-2"></i>View Details
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteCompetitor('${competitor.id}')">
                            <i class="mdi mdi-delete me-2"></i>Delete
                        </a></li>
                    </ul>
                </div>
            </td>
        </tr>
    `).join('');
}

// Get badge classes
function getLevelBadge(level) {
    switch (level) {
        case 'Direct': return 'bg-danger';
        case 'Indirect': return 'bg-warning';
        case 'Substitute': return 'bg-info';
        default: return 'bg-secondary';
    }
}

function getThreatBadge(threat) {
    switch (threat) {
        case 'High': return 'bg-danger';
        case 'Medium': return 'bg-warning';
        case 'Low': return 'bg-success';
        default: return 'bg-secondary';
    }
}

// Update bulk actions
function updateBulkActions() {
    const checkboxes = document.querySelectorAll('.competitor-checkbox:checked');
    const bulkActions = document.getElementById('bulkActions');
    
    if (checkboxes.length > 0) {
        bulkActions.classList.remove('d-none');
    } else {
        bulkActions.classList.add('d-none');
    }
}

// Initialize filters and search
document.getElementById('marketFilter').addEventListener('change', filterCompetitors);
document.getElementById('levelFilter').addEventListener('change', filterCompetitors);
document.getElementById('threatFilter').addEventListener('change', filterCompetitors);
document.getElementById('searchCompetitors').addEventListener('input', filterCompetitors);

function filterCompetitors() {
    const marketFilter = document.getElementById('marketFilter').value;
    const levelFilter = document.getElementById('levelFilter').value;
    const threatFilter = document.getElementById('threatFilter').value;
    const searchTerm = document.getElementById('searchCompetitors').value.toLowerCase();
    
    let filtered = allCompetitors.filter(competitor => {
        const matchesMarket = !marketFilter || competitor.industry === marketFilter;
        const matchesLevel = !levelFilter || competitor.market_position === levelFilter;
        const matchesThreat = !threatFilter || competitor.threat_level === threatFilter;
        const matchesSearch = !searchTerm || 
            competitor.competitor_name?.toLowerCase().includes(searchTerm) ||
            competitor.target_audience?.toLowerCase().includes(searchTerm) ||
            competitor.strengths?.toLowerCase().includes(searchTerm);
        
        return matchesMarket && matchesLevel && matchesThreat && matchesSearch;
    });
    
    renderCompetitors(filtered);
}

// Add competitor
document.getElementById('addCompetitorForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const competitorData = Object.fromEntries(formData.entries());
    
    try {
        showButtonLoading('addCompetitorBtnText', 'addCompetitorSpinner');
        
        const response = await fetch(`/api/projects/${projectId}/competitors`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(competitorData)
        });

        if (!response.ok) {
            throw new Error('Failed to create competitor');
        }

        hideButtonLoading('addCompetitorBtnText', 'addCompetitorSpinner', 'Add Competitor');
        bootstrap.Modal.getInstance(document.getElementById('addCompetitorModal')).hide();
        e.target.reset();
        
        await loadCompetitors();
        showSuccess('Competitor added successfully!');
    } catch (error) {
        console.error('Error creating competitor:', error);
        hideButtonLoading('addCompetitorBtnText', 'addCompetitorSpinner', 'Add Competitor');
        showError('Failed to add competitor');
    }
});

// Utility functions
function showButtonLoading(textId, spinnerId) {
    document.getElementById(textId).classList.add('d-none');
    document.getElementById(spinnerId).classList.remove('d-none');
}

function hideButtonLoading(textId, spinnerId, originalText) {
    document.getElementById(textId).classList.remove('d-none');
    document.getElementById(textId).textContent = originalText;
    document.getElementById(spinnerId).classList.add('d-none');
}

function showSuccess(message) {
    console.log('Success:', message);
}

function showError(message) {
    console.log('Error:', message);
}

// Initialize project context
document.addEventListener('DOMContentLoaded', function() {
    projectId = getProjectIdFromURL();
    
    if (projectId) {
        document.getElementById('back-button-container').style.display = 'block';
        
        // Projects loaded from API
        const projects = [];
        const project = projects.find(p => p.id === projectId);
        if (project) {
            document.getElementById('projectContext').textContent = `Project: ${project.name}`;
        }
        
        loadCompetitors();
    } else {
        document.getElementById('projectContext').textContent = 'No project selected';
    }
});

// Checkbox handling
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('competitor-checkbox') || e.target.id === 'selectAll') {
        updateBulkActions();
    }
});

console.log('🏢 Competitor Analysis loaded!');
</script>

<%- contentFor('extra_javascript') %>
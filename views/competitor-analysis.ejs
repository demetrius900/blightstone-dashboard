<%- contentFor('html_attribute') %>
<%- contentFor('extra_css') %>

<style>
/* Fix dropdown overflow in tables */
.table-responsive {
    overflow: visible !important;
}

.dropdown-menu {
    z-index: 1050 !important;
    position: absolute !important;
}

.table .dropdown {
    position: static;
}

.table .dropdown-menu {
    position: absolute;
    z-index: 1050;
    transform: translate3d(0px, 0px, 0px) !important;
}

/* Ensure dropdowns don't get clipped */
.card-body {
    overflow: visible;
}
</style>
<%- contentFor('body_attribute') %>
<%- contentFor('content') %>

<div class="container-fluid">
    <!-- Page Title -->
    <div class="py-3 d-flex align-items-sm-center flex-sm-row flex-column">
        <div class="flex-grow-1">
            <div class="d-flex align-items-center">
                <div id="back-button-container" style="display: none;">
                    <a href="javascript:history.back()" class="btn btn-outline-secondary me-3">
                        <i class="mdi mdi-arrow-left"></i> Back
                    </a>
                </div>
                <div>
                    <h4 class="fs-18 fw-semibold m-0">Competitor Analysis</h4>
                    <p class="text-muted mb-0" id="projectContext">Analyze competition and market positioning</p>
                </div>
            </div>
        </div>
        <div class="text-end">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCompetitorModal">
                <i class="mdi mdi-plus me-2"></i>Add Competitor
            </button>
            <button class="btn btn-secondary ms-2" onclick="exportCompetitorData()">
                <i class="mdi mdi-download me-2"></i>Export
            </button>
        </div>
    </div>

    <!-- Competitor Analysis Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <!-- Filters -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <select class="form-select" id="marketFilter">
                                <option value="">All Markets</option>
                                <option value="E-commerce">E-commerce</option>
                                <option value="SaaS">SaaS</option>
                                <option value="Retail">Retail</option>
                                <option value="Services">Services</option>
                                <option value="Manufacturing">Manufacturing</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="levelFilter">
                                <option value="">All Competition Levels</option>
                                <option value="Direct">Direct</option>
                                <option value="Indirect">Indirect</option>
                                <option value="Substitute">Substitute</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="threatFilter">
                                <option value="">All Threat Levels</option>
                                <option value="High">High</option>
                                <option value="Medium">Medium</option>
                                <option value="Low">Low</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="searchCompetitors" placeholder="Search competitors...">
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover" id="competitorsTable">
                            <thead class="table-light">
                                <tr>
                                    <th width="3%">
                                        <input type="checkbox" id="selectAll" class="form-check-input">
                                    </th>
                                    <th width="12%">Competitor</th>
                                    <th width="8%">Industry</th>
                                    <th width="8%">Position</th>
                                    <th width="10%">Strengths</th>
                                    <th width="10%">Weaknesses</th>
                                    <th width="8%">Pricing</th>
                                    <th width="10%">Marketing</th>
                                    <th width="10%">Target Audience</th>
                                    <th width="8%">Website</th>
                                    <th width="8%">Notes</th>
                                    <th width="5%">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="competitorsTableBody">
                                <tr>
                                    <td colspan="12" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2">Loading competitors...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Bulk Actions -->
                    <div class="d-none" id="bulkActions">
                        <div class="bg-light p-3 rounded mb-3">
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-warning" onclick="bulkUpdateThreat('High')">
                                    <i class="mdi mdi-alert me-1"></i>Mark High Threat
                                </button>
                                <button class="btn btn-sm btn-info" onclick="bulkExportCompetitors()">
                                    <i class="mdi mdi-download me-1"></i>Export Selected
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="bulkDeleteCompetitors()">
                                    <i class="mdi mdi-delete me-1"></i>Delete Selected
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Competitor Modal -->
<div class="modal fade" id="addCompetitorModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Competitor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addCompetitorForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Competitor Name *</label>
                            <input type="text" class="form-control" name="competitor_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Website</label>
                            <input type="url" class="form-control" name="website" placeholder="https://example.com">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Market</label>
                            <select class="form-select" name="industry">
                                <option value="E-commerce">E-commerce</option>
                                <option value="SaaS">SaaS</option>
                                <option value="Retail">Retail</option>
                                <option value="Services">Services</option>
                                <option value="Manufacturing">Manufacturing</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Competition Level</label>
                            <select class="form-select" name="market_position">
                                <option value="Direct">Direct</option>
                                <option value="Indirect">Indirect</option>
                                <option value="Substitute">Substitute</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Threat Level</label>
                            <select class="form-select" name="threat_level">
                                <option value="Low">Low</option>
                                <option value="Medium" selected>Medium</option>
                                <option value="High">High</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Products/Focus</label>
                            <textarea class="form-control" name="target_audience" rows="2" placeholder="Who is their target audience?"></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Target Market</label>
                            <textarea class="form-control" name="target_market" rows="2" placeholder="Who is their target audience?"></textarea>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Strengths</label>
                            <textarea class="form-control" name="strengths" rows="3" placeholder="What are they good at?"></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Weaknesses</label>
                            <textarea class="form-control" name="weaknesses" rows="3" placeholder="What are their weak points?"></textarea>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Pricing Strategy</label>
                            <textarea class="form-control" name="pricing_model" rows="2" placeholder="How do they price their products?"></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Marketing Strategy</label>
                            <textarea class="form-control" name="marketing_channels" rows="2" placeholder="How do they market themselves?"></textarea>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Traffic Estimate</label>
                            <input type="text" class="form-control" name="traffic_estimate" placeholder="e.g., 100K monthly visitors">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Revenue Estimate</label>
                            <input type="text" class="form-control" name="revenue_estimate" placeholder="e.g., $1M ARR">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Additional Notes</label>
                        <textarea class="form-control" name="notes" rows="3" placeholder="Any other observations or notes..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <span id="addCompetitorBtnText">Add Competitor</span>
                        <span id="addCompetitorSpinner" class="spinner-border spinner-border-sm d-none ms-2"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Competitor Details Modal -->
<div class="modal fade" id="viewCompetitorModal" tabindex="-1" aria-labelledby="viewCompetitorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewCompetitorModalLabel">Competitor Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Competitor Name</label>
                            <p id="viewCompetitorName" class="form-control-plaintext"></p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Industry</label>
                            <p id="viewCompetitorIndustry" class="form-control-plaintext"></p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Market Position</label>
                            <p id="viewCompetitorPosition" class="form-control-plaintext"></p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Website</label>
                            <p id="viewCompetitorWebsite" class="form-control-plaintext"></p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Strengths</label>
                            <p id="viewCompetitorStrengths" class="form-control-plaintext"></p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Weaknesses</label>
                            <p id="viewCompetitorWeaknesses" class="form-control-plaintext"></p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Pricing Strategy</label>
                            <p id="viewCompetitorPricing" class="form-control-plaintext"></p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Marketing Strategy</label>
                            <p id="viewCompetitorMarketing" class="form-control-plaintext"></p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Target Audience</label>
                            <p id="viewCompetitorTargetAudience" class="form-control-plaintext"></p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Notes</label>
                            <p id="viewCompetitorNotes" class="form-control-plaintext"></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="editCompetitorFromView()">Edit Competitor</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Competitor Modal -->
<div class="modal fade" id="deleteCompetitorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Competitor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong id="deleteCompetitorName"></strong>?</p>
                <p class="text-muted small">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteCompetitor()">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Competitor Modal -->
<div class="modal fade" id="editCompetitorModal" tabindex="-1" aria-labelledby="editCompetitorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCompetitorModalLabel">Edit Competitor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editCompetitorForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editCompetitorName" class="form-label">Competitor Name</label>
                                <input type="text" class="form-control" id="editCompetitorName" name="competitor_name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editIndustry" class="form-label">Industry</label>
                                <select class="form-select" id="editIndustry" name="industry">
                                    <option value="E-commerce">E-commerce</option>
                                    <option value="SaaS">SaaS</option>
                                    <option value="Mobile App">Mobile App</option>
                                    <option value="Digital Marketing">Digital Marketing</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editMarketPosition" class="form-label">Market Position</label>
                                <select class="form-select" id="editMarketPosition" name="market_position">
                                    <option value="Direct">Direct</option>
                                    <option value="Indirect">Indirect</option>
                                    <option value="Substitute">Substitute</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editThreatLevel" class="form-label">Threat Level</label>
                                <select class="form-select" id="editThreatLevel" name="threat_level">
                                    <option value="High">High</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Low">Low</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editStrengths" class="form-label">Strengths</label>
                                <textarea class="form-control" id="editStrengths" name="strengths" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editWeaknesses" class="form-label">Weaknesses</label>
                                <textarea class="form-control" id="editWeaknesses" name="weaknesses" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editOpportunities" class="form-label">Opportunities</label>
                                <textarea class="form-control" id="editOpportunities" name="opportunities" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editThreats" class="form-label">Threats</label>
                                <textarea class="form-control" id="editThreats" name="threats" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editKeyStrategies" class="form-label">Key Strategies</label>
                                <textarea class="form-control" id="editKeyStrategies" name="key_strategies" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editPricingModel" class="form-label">Pricing Model</label>
                                <textarea class="form-control" id="editPricingModel" name="pricing_model" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editTargetAudience" class="form-label">Target Audience</label>
                                <textarea class="form-control" id="editTargetAudience" name="target_audience" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editMarketingChannels" class="form-label">Marketing Channels</label>
                                <textarea class="form-control" id="editMarketingChannels" name="marketing_channels" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="editNotes" name="notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <span id="editCompetitorBtnText">Update Competitor</span>
                        <span id="editCompetitorSpinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let projectId;
let allCompetitors = [];

// Get project ID from URL
function getProjectIdFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('id');
}

// Load competitors from API
async function loadCompetitors() {
    try {
        showLoadingState();
        
        const response = await fetch(`/api/projects/${projectId}/competitors`);
        if (response.ok) {
            const competitors = await response.json();
            allCompetitors = competitors;
            
            renderCompetitors(competitors);
            updateBulkActions();
            
            // console.log('✅ Competitors loaded:', competitors.length);
        } else {
            throw new Error('Failed to load competitors');
        }
    } catch (error) {
        console.error('Error loading competitors:', error);
        showErrorState('Failed to load competitors');
    }
}

// Show loading state
function showLoadingState() {
    const tbody = document.getElementById('competitorsTableBody');
    tbody.innerHTML = `
        <tr>
            <td colspan="8" class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading competitors...</p>
            </td>
        </tr>
    `;
}

// Show error state
function showErrorState(message) {
    const tbody = document.getElementById('competitorsTableBody');
    tbody.innerHTML = `
        <tr>
            <td colspan="8" class="text-center py-4">
                <i class="mdi mdi-alert-circle fs-48 text-muted"></i>
                <h5 class="mt-3">Error</h5>
                <p class="text-muted">${message}</p>
                <button class="btn btn-primary" onclick="loadCompetitors()">
                    <i class="mdi mdi-refresh me-2"></i>Retry
                </button>
            </td>
        </tr>
    `;
}

// Render competitors table
function renderCompetitors(competitors) {
    const tbody = document.getElementById('competitorsTableBody');
    
    if (competitors.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="12" class="text-center py-4">
                    <i class="mdi mdi-chart-line fs-48 text-muted"></i>
                    <h5 class="mt-3">No Competitors Yet</h5>
                    <p class="text-muted">Add your first competitor analysis</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCompetitorModal">
                        <i class="mdi mdi-plus me-2"></i>Add Competitor
                    </button>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = competitors.map(competitor => `
        <tr data-id="${competitor.id}">
            <td>
                <input type="checkbox" class="form-check-input competitor-checkbox" value="${competitor.id}">
            </td>
            <td>
                <div class="d-flex align-items-center">
                    <div class="competitor-icon me-2">
                        <i class="mdi mdi-domain fs-16 text-primary"></i>
                    </div>
                    <div>
                        <span class="fw-semibold small">${competitor.competitor_name || ''}</span>
                    </div>
                </div>
            </td>
            <td>
                <span class="badge bg-info small">${competitor.industry || '-'}</span>
            </td>
            <td>
                <span class="badge ${getLevelBadge(competitor.market_position)} small">${competitor.market_position || '-'}</span>
            </td>
            <td>
                <span class="text-truncate d-inline-block small" style="max-width: 120px;" title="${competitor.strengths || ''}">${competitor.strengths || '-'}</span>
            </td>
            <td>
                <span class="text-truncate d-inline-block small" style="max-width: 120px;" title="${competitor.weaknesses || ''}">${competitor.weaknesses || '-'}</span>
            </td>
            <td>
                <span class="text-truncate d-inline-block small" style="max-width: 100px;" title="${competitor.pricing_model || ''}">${competitor.pricing_model || '-'}</span>
            </td>
            <td>
                <span class="text-truncate d-inline-block small" style="max-width: 120px;" title="${competitor.marketing_channels || ''}">${competitor.marketing_channels || '-'}</span>
            </td>
            <td>
                <span class="text-truncate d-inline-block small" style="max-width: 120px;" title="${competitor.target_audience || ''}">${competitor.target_audience || '-'}</span>
            </td>
            <td>
                ${competitor.website ? `<a href="${competitor.website}" target="_blank" class="btn btn-sm btn-outline-primary btn-xs">Visit</a>` : '-'}
            </td>
            <td>
                <span class="text-truncate d-inline-block small" style="max-width: 100px;" title="${competitor.notes || ''}">${competitor.notes || '-'}</span>
            </td>
            <td>
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="mdi mdi-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="editCompetitor('${competitor.id}')">
                            <i class="mdi mdi-pencil me-2"></i>Edit
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="viewCompetitorDetails('${competitor.id}')">
                            <i class="mdi mdi-eye me-2"></i>View Details
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteCompetitor('${competitor.id}')">
                            <i class="mdi mdi-delete me-2"></i>Delete
                        </a></li>
                    </ul>
                </div>
            </td>
        </tr>
    `).join('');
}

// Get badge classes
function getLevelBadge(level) {
    switch (level) {
        case 'Direct': return 'bg-danger';
        case 'Indirect': return 'bg-warning';
        case 'Substitute': return 'bg-info';
        default: return 'bg-secondary';
    }
}

function getThreatBadge(threat) {
    switch (threat) {
        case 'High': return 'bg-danger';
        case 'Medium': return 'bg-warning';
        case 'Low': return 'bg-success';
        default: return 'bg-secondary';
    }
}

// Update bulk actions
function updateBulkActions() {
    const checkboxes = document.querySelectorAll('.competitor-checkbox:checked');
    const bulkActions = document.getElementById('bulkActions');
    
    if (checkboxes.length > 0) {
        bulkActions.classList.remove('d-none');
    } else {
        bulkActions.classList.add('d-none');
    }
}

// Initialize filters and search
document.getElementById('marketFilter').addEventListener('change', filterCompetitors);
document.getElementById('levelFilter').addEventListener('change', filterCompetitors);
document.getElementById('threatFilter').addEventListener('change', filterCompetitors);
document.getElementById('searchCompetitors').addEventListener('input', filterCompetitors);

function filterCompetitors() {
    const marketFilter = document.getElementById('marketFilter').value;
    const levelFilter = document.getElementById('levelFilter').value;
    const threatFilter = document.getElementById('threatFilter').value;
    const searchTerm = document.getElementById('searchCompetitors').value.toLowerCase();
    
    let filtered = allCompetitors.filter(competitor => {
        const matchesMarket = !marketFilter || competitor.industry === marketFilter;
        const matchesLevel = !levelFilter || competitor.market_position === levelFilter;
        const matchesThreat = !threatFilter || competitor.threat_level === threatFilter;
        const matchesSearch = !searchTerm || 
            competitor.competitor_name?.toLowerCase().includes(searchTerm) ||
            competitor.target_audience?.toLowerCase().includes(searchTerm) ||
            competitor.strengths?.toLowerCase().includes(searchTerm);
        
        return matchesMarket && matchesLevel && matchesThreat && matchesSearch;
    });
    
    renderCompetitors(filtered);
}

// Add competitor
document.getElementById('addCompetitorForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const competitorData = Object.fromEntries(formData.entries());
    
    try {
        showButtonLoading('addCompetitorBtnText', 'addCompetitorSpinner');
        
        const response = await fetch(`/api/projects/${projectId}/competitors`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(competitorData)
        });

        if (!response.ok) {
            throw new Error('Failed to create competitor');
        }

        hideButtonLoading('addCompetitorBtnText', 'addCompetitorSpinner', 'Add Competitor');
        bootstrap.Modal.getInstance(document.getElementById('addCompetitorModal')).hide();
        e.target.reset();
        
        await loadCompetitors();
        showSuccess('Competitor added successfully!');
    } catch (error) {
        console.error('Error creating competitor:', error);
        hideButtonLoading('addCompetitorBtnText', 'addCompetitorSpinner', 'Add Competitor');
        showError('Failed to add competitor');
    }
});

// Utility functions
function showButtonLoading(textId, spinnerId) {
    document.getElementById(textId).classList.add('d-none');
    document.getElementById(spinnerId).classList.remove('d-none');
}

function hideButtonLoading(textId, spinnerId, originalText) {
    document.getElementById(textId).classList.remove('d-none');
    document.getElementById(textId).textContent = originalText;
    document.getElementById(spinnerId).classList.add('d-none');
}

function showSuccess(message) {
    if (window.toast && window.toast.success) {
        window.toast.success(message);
    } else {
        // console.log('Success:', message);
        // Fallback to browser alert if toast is not available
        // alert(message);
    }
}

// Edit competitor
function editCompetitor(id) {
    const competitor = allCompetitors.find(c => c.id === id);
    if (!competitor) return;
    
    // Populate edit form
    document.getElementById('editCompetitorName').value = competitor.competitor_name || '';
    document.getElementById('editIndustry').value = competitor.industry || '';
    document.getElementById('editMarketPosition').value = competitor.market_position || '';
    document.getElementById('editThreatLevel').value = competitor.threat_level || '';
    document.getElementById('editStrengths').value = competitor.strengths || '';
    document.getElementById('editWeaknesses').value = competitor.weaknesses || '';
    document.getElementById('editOpportunities').value = competitor.opportunities || '';
    document.getElementById('editThreats').value = competitor.threats || '';
    document.getElementById('editKeyStrategies').value = competitor.key_strategies || '';
    document.getElementById('editPricingModel').value = competitor.pricing_model || '';
    document.getElementById('editTargetAudience').value = competitor.target_audience || '';
    document.getElementById('editMarketingChannels').value = competitor.marketing_channels || '';
    document.getElementById('editNotes').value = competitor.notes || '';
    
    // Store the competitor ID for the form submission
    document.getElementById('editCompetitorForm').dataset.competitorId = id;
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('editCompetitorModal'));
    modal.show();
}

// Handle edit form submission
document.getElementById('editCompetitorForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const competitorId = this.dataset.competitorId;
    if (!competitorId) {
        showError('No competitor selected for editing');
        return;
    }
    
    const formData = new FormData(e.target);
    const competitorData = Object.fromEntries(formData.entries());
    
    try {
        showButtonLoading('editCompetitorBtnText', 'editCompetitorSpinner');
        
        const response = await fetch(`/api/projects/${projectId}/competitors/${competitorId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(competitorData)
        });
        
        if (!response.ok) {
            throw new Error('Failed to update competitor');
        }
        
        hideButtonLoading('editCompetitorBtnText', 'editCompetitorSpinner', 'Update Competitor');
        bootstrap.Modal.getInstance(document.getElementById('editCompetitorModal')).hide();
        e.target.reset();
        
        await loadCompetitors();
        showSuccess('Competitor updated successfully!');
    } catch (error) {
        console.error('Error updating competitor:', error);
        hideButtonLoading('editCompetitorBtnText', 'editCompetitorSpinner', 'Update Competitor');
        showError('Failed to update competitor');
    }
});

// View competitor details
function viewCompetitorDetails(id) {
    const competitor = allCompetitors.find(c => c.id === id);
    if (!competitor) return;
    
    // Ensure Bootstrap is loaded
    if (typeof bootstrap === 'undefined') {
        console.error('❌ Bootstrap not loaded yet, retrying...');
        setTimeout(() => viewCompetitorDetails(id), 100);
        return;
    }
    
    // Populate modal with competitor data
    document.getElementById('viewCompetitorName').textContent = competitor.competitor_name || 'N/A';
    document.getElementById('viewCompetitorIndustry').textContent = competitor.industry || 'N/A';
    document.getElementById('viewCompetitorPosition').textContent = competitor.market_position || 'N/A';
    document.getElementById('viewCompetitorWebsite').textContent = competitor.website || 'N/A';
    document.getElementById('viewCompetitorStrengths').textContent = competitor.strengths || 'N/A';
    document.getElementById('viewCompetitorWeaknesses').textContent = competitor.weaknesses || 'N/A';
    document.getElementById('viewCompetitorPricing').textContent = competitor.pricing_strategy || 'N/A';
    document.getElementById('viewCompetitorMarketing').textContent = competitor.marketing_strategy || 'N/A';
    document.getElementById('viewCompetitorTargetAudience').textContent = competitor.target_audience || 'N/A';
    document.getElementById('viewCompetitorNotes').textContent = competitor.notes || 'N/A';
    
    // Store competitor ID for potential edit action
    document.getElementById('viewCompetitorModal').dataset.competitorId = id;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('viewCompetitorModal'));
    modal.show();
}

// Edit competitor from view modal
function editCompetitorFromView() {
    const viewModal = bootstrap.Modal.getInstance(document.getElementById('viewCompetitorModal'));
    const competitorId = document.getElementById('viewCompetitorModal').dataset.competitorId;
    
    if (viewModal) {
        viewModal.hide();
    }
    
    // Wait for view modal to close, then open edit modal
    setTimeout(() => {
        editCompetitor(competitorId);
    }, 300);
}

// Delete competitor - show modal
let deleteCompetitorId = null;

function deleteCompetitor(id) {
    const competitor = allCompetitors.find(c => c.id === id);
    if (!competitor) return;
    
    deleteCompetitorId = id;
    document.getElementById('deleteCompetitorName').textContent = competitor.competitor_name;
    
    const modal = new bootstrap.Modal(document.getElementById('deleteCompetitorModal'));
    modal.show();
}

// Confirm delete competitor
async function confirmDeleteCompetitor() {
    if (!deleteCompetitorId) return;
    
    try {
        const response = await fetch(`/api/projects/${projectId}/competitors/${deleteCompetitorId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error('Failed to delete competitor');
        }
        
        bootstrap.Modal.getInstance(document.getElementById('deleteCompetitorModal')).hide();
        await loadCompetitors();
        showSuccess('Competitor deleted successfully!');
        
        deleteCompetitorId = null;
    } catch (error) {
        console.error('Error deleting competitor:', error);
        showError('Failed to delete competitor');
    }
}

function showError(message) {
    if (window.toast) {
        window.toast.error(message);
    } else {
        // console.log('Error:', message);
    }
}

// Initialize project context
document.addEventListener('DOMContentLoaded', function() {
    projectId = getProjectIdFromURL();
    
    if (projectId) {
        document.getElementById('back-button-container').style.display = 'block';
        
        // Project context will be handled by the project switcher
        // No need to fetch projects array here since we're already in project context
        
        loadCompetitors();
    } else {
        document.getElementById('projectContext').textContent = 'No project selected';
    }
});

// Checkbox handling
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('competitor-checkbox') || e.target.id === 'selectAll') {
        updateBulkActions();
    }
});

        // console.log('🏢 Competitor Analysis loaded!');
</script>

<%- contentFor('extra_javascript') %>
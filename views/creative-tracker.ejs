<%- contentFor('html_attribute') %>
<%- contentFor('extra_css') %>

<style>
/* Fix dropdown overflow in tables */
.table-responsive {
    overflow: visible !important;
}

.dropdown-menu {
    z-index: 1050 !important;
    position: absolute !important;
}

.table .dropdown {
    position: static;
}

.table .dropdown-menu {
    position: absolute;
    z-index: 1050;
    transform: translate3d(0px, 0px, 0px) !important;
}

/* Ensure dropdowns don't get clipped */
.card-body {
    overflow: visible;
}
</style>
<%- contentFor('body_attribute') %>
<%- contentFor('content') %>

<div class="container-fluid">
    <!-- Page Title -->
    <div class="py-3 d-flex align-items-sm-center flex-sm-row flex-column">
        <div class="flex-grow-1">
            <div class="d-flex align-items-center">
                <div id="back-button-container" style="display: none;">
                    <a href="javascript:history.back()" class="btn btn-outline-secondary me-3">
                        <i class="mdi mdi-arrow-left"></i> Back
                    </a>
                </div>
                <div>
                    <h4 class="fs-18 fw-semibold m-0">Creative Tracker</h4>
                    <p class="text-muted mb-0" id="projectContext">Track ad creatives, testing, and performance</p>
                </div>
            </div>
        </div>
        <div class="text-end">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCreativeModal">
                <i class="mdi mdi-plus me-2"></i>Add Creative
            </button>
            <button class="btn btn-secondary ms-2" onclick="exportCreativeData()">
                <i class="mdi mdi-download me-2"></i>Export
            </button>
        </div>
    </div>

    <!-- Creative Tracker Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <!-- Filters -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <select class="form-select" id="statusFilter">
                                <option value="">All Status</option>
                                <option value="Planning">Planning</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Testing">Testing</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="adTypeFilter">
                                <option value="">All Types</option>
                                <option value="Video">Video</option>
                                <option value="Image">Image</option>
                                <option value="Carousel">Carousel</option>
                                <option value="Story">Story</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="brandFilter">
                                <option value="">All Brands</option>
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="searchCreatives" placeholder="Search creatives...">
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover" id="creativesTable">
                            <thead class="table-light">
                                <tr>
                                    <th width="2%">
                                        <input type="checkbox" id="selectAll" class="form-check-input">
                                    </th>
                                    <th width="5%">Batch #</th>
                                    <th width="7%">Brand</th>
                                    <th width="6%">Status</th>
                                    <th width="7%">Launch Date</th>
                                    <th width="9%">Ad Concept</th>
                                    <th width="6%">Ad Type</th>
                                    <th width="7%">Variable</th>
                                    <th width="7%">Desire</th>
                                    <th width="7%">Benefits</th>
                                    <th width="7%">Objections</th>
                                    <th width="7%">Persona</th>
                                    <th width="8%">Positioning</th>
                                    <th width="7%">Hook Pattern</th>
                                    <th width="7%">Results</th>
                                    <th width="5%">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="creativesTableBody">
                                <tr>
                                    <td colspan="16" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2">Loading creatives...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Bulk Actions -->
                    <div class="d-none" id="bulkActions">
                        <div class="bg-light p-3 rounded mb-3">
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-success" onclick="bulkUpdateStatus('Completed')">
                                    <i class="mdi mdi-check me-1"></i>Mark Completed
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="bulkUpdateStatus('Testing')">
                                    <i class="mdi mdi-flask me-1"></i>Mark Testing
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="bulkDeleteCreatives()">
                                    <i class="mdi mdi-delete me-1"></i>Delete Selected
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Creative Multi-Step Modal -->
<div class="modal fade" id="addCreativeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h5 class="modal-title">Add Creative Entry</h5>
                    <div class="step-progress-container mt-3">
                        <div class="step-progress">
                            <div class="step-item active" data-step="1">
                                <div class="step-circle">1</div>
                                <div class="step-label">Basic Info</div>
                            </div>
                            <div class="step-line"></div>
                            <div class="step-item" data-step="2">
                                <div class="step-circle">2</div>
                                <div class="step-label">Creative Details</div>
                            </div>
                            <div class="step-line"></div>
                            <div class="step-item" data-step="3">
                                <div class="step-circle">3</div>
                                <div class="step-label">Results & Links</div>
                            </div>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addCreativeForm">
                <div class="modal-body" style="min-height: 400px;">
                    
                    <!-- Step 1: Basic Information -->
                    <div class="step-content" id="step1" style="display: block;">
                        <h6 class="mb-3 text-primary">üìù Basic Information</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Batch # *</label>
                                <input type="text" class="form-control" name="batch_number" placeholder="B001" required>
                                <small class="text-muted">Unique identifier for this creative batch</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Brand *</label>
                                <input type="text" class="form-control" name="brand" required>
                                <small class="text-muted">Which brand is this creative for?</small>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" name="status">
                                    <option value="Planning">Planning</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Testing">Testing</option>
                                    <option value="Completed">Completed</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Launch Date</label>
                                <input type="date" class="form-control" name="launch_date">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ad Type</label>
                                <select class="form-select" name="ad_type">
                                    <option value="Video">Video</option>
                                    <option value="Image">Image</option>
                                    <option value="Carousel">Carousel</option>
                                    <option value="Story">Story</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ad Concept</label>
                                <input type="text" class="form-control" name="ad_concept" placeholder="Concept inspiration">
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Creative Strategy -->
                    <div class="step-content" id="step2" style="display: none;">
                        <h6 class="mb-3 text-primary">üéØ Creative Strategy</h6>
                        <div class="mb-3">
                            <label class="form-label">Testing Goals</label>
                            <textarea class="form-control" name="testing_goals" rows="3" placeholder="What are you creating/testing and what gives you confidence this test will improve performance?"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ad Variable</label>
                            <input type="text" class="form-control" name="ad_variable" placeholder="What specific element are you testing?">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Target Persona</label>
                                <input type="text" class="form-control" name="persona" placeholder="Who is this for?">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Desire/Motivation</label>
                                <input type="text" class="form-control" name="desire" placeholder="What do they want?">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Benefits Focus</label>
                            <textarea class="form-control" name="benefits" rows="2" placeholder="Focus on pain points and objections to determine which benefits to highlight"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Objections to Address</label>
                            <textarea class="form-control" name="objections" rows="2" placeholder="What concerns might they have?"></textarea>
                        </div>
                    </div>

                    <!-- Step 3: Positioning & Results -->
                    <div class="step-content" id="step3" style="display: none;">
                        <h6 class="mb-3 text-primary">üöÄ Positioning & Results</h6>
                        <div class="mb-3">
                            <label class="form-label">Positioning Strategy</label>
                            <input type="text" class="form-control" name="positioning" placeholder="How will you position this concept?">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Hook Pattern</label>
                            <input type="text" class="form-control" name="hook_pattern" placeholder="Describe how the hook will look like">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Results</label>
                                <input type="text" class="form-control" name="results" placeholder="Performance metrics">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Best Performing Ad</label>
                                <input type="text" class="form-control" name="best_ad" placeholder="Link to winning creative">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Brief Link</label>
                            <input type="url" class="form-control" name="brief_link" placeholder="https://link-to-creative-brief">
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-outline-primary" id="prevStep" style="display: none;">
                        <i class="mdi mdi-arrow-left me-1"></i>Previous
                    </button>
                    <button type="button" class="btn btn-primary" id="nextStep">
                        Next <i class="mdi mdi-arrow-right ms-1"></i>
                    </button>
                    <button type="submit" class="btn btn-success" id="submitCreative" style="display: none;">
                        <span id="addCreativeBtnText"><i class="mdi mdi-check me-1"></i>Add Creative</span>
                        <span id="addCreativeSpinner" class="spinner-border spinner-border-sm d-none ms-2"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Creative Modal -->
<div class="modal fade" id="editCreativeModal" tabindex="-1" aria-labelledby="editCreativeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCreativeModalLabel">Edit Creative Entry</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editCreativeForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="editBatchNumber" class="form-label">Batch Number</label>
                                <input type="text" class="form-control" id="editBatchNumber" name="batch_number" placeholder="B001" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="editBrand" class="form-label">Brand</label>
                                <input type="text" class="form-control" id="editBrand" name="brand" placeholder="Brand name">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="editStatus" class="form-label">Status</label>
                                <select class="form-select" id="editStatus" name="status">
                                    <option value="Draft">Draft</option>
                                    <option value="In Review">In Review</option>
                                    <option value="Approved">Approved</option>
                                    <option value="Live">Live</option>
                                    <option value="Paused">Paused</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editLaunchDate" class="form-label">Launch Date</label>
                                <input type="date" class="form-control" id="editLaunchDate" name="launch_date">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editAdConcept" class="form-label">Ad Concept</label>
                                <input type="text" class="form-control" id="editAdConcept" name="ad_concept" placeholder="Brief concept description">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="editAdType" class="form-label">Ad Type</label>
                                <select class="form-select" id="editAdType" name="ad_type">
                                    <option value="Image">Image</option>
                                    <option value="Video">Video</option>
                                    <option value="Carousel">Carousel</option>
                                    <option value="Story">Story</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="editAdVariable" class="form-label">Ad Variable</label>
                                <input type="text" class="form-control" id="editAdVariable" name="ad_variable" placeholder="A/B test variable">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="editDesire" class="form-label">Desire</label>
                                <input type="text" class="form-control" id="editDesire" name="desire" placeholder="Customer desire">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editBenefitFocus" class="form-label">Benefit Focus</label>
                                <textarea class="form-control" id="editBenefitFocus" name="benefit_focus" rows="3" placeholder="Main benefits highlighted"></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editObjections" class="form-label">Objections</label>
                                <textarea class="form-control" id="editObjections" name="objections" rows="3" placeholder="Common objections addressed"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editPersona" class="form-label">Persona</label>
                                <input type="text" class="form-control" id="editPersona" name="persona" placeholder="Target persona">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editPositioningConcept" class="form-label">Positioning Concept</label>
                                <input type="text" class="form-control" id="editPositioningConcept" name="positioning_concept" placeholder="Positioning concept">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editPositioningHow" class="form-label">Positioning How</label>
                                <textarea class="form-control" id="editPositioningHow" name="positioning_how" rows="3" placeholder="How positioning is executed"></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editHookPattern" class="form-label">Hook Pattern</label>
                                <input type="text" class="form-control" id="editHookPattern" name="hook_pattern" placeholder="Hook pattern used">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editResults" class="form-label">Results</label>
                                <textarea class="form-control" id="editResults" name="results" rows="3" placeholder="Performance results"></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editWinningAds" class="form-label">Winning Ads</label>
                                <textarea class="form-control" id="editWinningAds" name="winning_ads" rows="3" placeholder="Winning ad variations"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editBriefLink" class="form-label">Brief Link</label>
                        <input type="url" class="form-control" id="editBriefLink" name="brief_link" placeholder="Link to creative brief">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <span id="editCreativeBtnText">Update Creative</span>
                        <span id="editCreativeSpinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Creative Details Modal -->
<div class="modal fade" id="viewCreativeModal" tabindex="-1" aria-labelledby="viewCreativeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewCreativeModalLabel">Creative Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Batch</label>
                            <p id="viewCreativeBatch" class="form-control-plaintext"></p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Brand</label>
                            <p id="viewCreativeBrand" class="form-control-plaintext"></p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Status</label>
                            <p id="viewCreativeStatus" class="form-control-plaintext"></p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Ad Concept</label>
                            <p id="viewCreativeAdConcept" class="form-control-plaintext"></p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Persona</label>
                            <p id="viewCreativePersona" class="form-control-plaintext"></p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Positioning Concept</label>
                            <p id="viewCreativePositioningConcept" class="form-control-plaintext"></p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Hook Pattern</label>
                            <p id="viewCreativeHookPattern" class="form-control-plaintext"></p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Brief Link</label>
                            <p id="viewCreativeBriefLink" class="form-control-plaintext"></p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Positioning How</label>
                            <p id="viewCreativePositioningHow" class="form-control-plaintext"></p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Results</label>
                            <p id="viewCreativeResults" class="form-control-plaintext"></p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Winning Ads</label>
                            <p id="viewCreativeWinningAds" class="form-control-plaintext"></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="editCreativeFromView()">Edit Creative</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Creative Modal -->
<div class="modal fade" id="deleteCreativeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Creative</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong id="deleteCreativeName"></strong>?</p>
                <p class="text-muted small">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteCreative()">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
let projectId;
let allCreatives = [];
let currentEditId = null;

// Get project ID from URL
function getProjectIdFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('id');
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    projectId = getProjectIdFromURL();
    if (projectId) {
        loadCreatives();
        setupEventListeners();
    } else {
        console.error('No project ID found in URL');
        window.location.href = '/projects';
    }
});

// Load creatives from API
async function loadCreatives() {
    try {
        showLoadingState();
        
        const response = await fetch(`/api/projects/${projectId}/creatives`);
        if (response.ok) {
            const creatives = await response.json();
            allCreatives = creatives;
            
            renderCreatives(creatives);
            updateFilters();
            updateBulkActions();
            
            // console.log('‚úÖ Creatives loaded:', creatives.length);
        } else {
            throw new Error('Failed to load creatives');
        }
    } catch (error) {
        console.error('Error loading creatives:', error);
        showErrorState('Failed to load creatives');
    }
}

// Show loading state
function showLoadingState() {
    const tbody = document.getElementById('creativesTableBody');
    tbody.innerHTML = `
        <tr>
                            <td colspan="16" class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading creatives...</p>
            </td>
        </tr>
    `;
}

// Show error state
function showErrorState(message) {
    const tbody = document.getElementById('creativesTableBody');
    tbody.innerHTML = `
        <tr>
                            <td colspan="16" class="text-center py-4">
                <i class="mdi mdi-alert-circle fs-48 text-muted"></i>
                <h5 class="mt-3">Error</h5>
                <p class="text-muted">${message}</p>
                <button class="btn btn-primary" onclick="loadCreatives()">
                    <i class="mdi mdi-refresh me-2"></i>Retry
                </button>
            </td>
        </tr>
    `;
}

// Render creatives table
function renderCreatives(creatives) {
    const tbody = document.getElementById('creativesTableBody');
    
    if (creatives.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="16" class="text-center py-4">
                    <i class="mdi mdi-palette fs-48 text-muted"></i>
                    <h5 class="mt-3">No Creatives Yet</h5>
                    <p class="text-muted">Add your first creative to start tracking</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCreativeModal">
                        <i class="mdi mdi-plus me-2"></i>Add Creative
                    </button>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = creatives.map(creative => `
        <tr data-id="${creative.id}">
            <td>
                <input type="checkbox" class="form-check-input creative-checkbox" value="${creative.id}">
            </td>
            <td>
                <span class="fw-semibold small">${creative.batch_number || '-'}</span>
            </td>
            <td>
                <span class="small">${creative.brand || '-'}</span>
            </td>
            <td>
                <span class="badge ${getStatusBadge(creative.status)} small">${creative.status || 'Planning'}</span>
            </td>
            <td>
                <span class="small">${creative.launch_date || '-'}</span>
            </td>
            <td>
                <span class="text-truncate d-inline-block small" style="max-width: 80px;" title="${creative.ad_concept || ''}">${creative.ad_concept || '-'}</span>
            </td>
            <td>
                <span class="small">${creative.ad_type || '-'}</span>
            </td>
            <td>
                <span class="text-truncate d-inline-block small" style="max-width: 60px;" title="${creative.ad_variable || ''}">${creative.ad_variable || '-'}</span>
            </td>
            <td>
                <span class="text-truncate d-inline-block small" style="max-width: 60px;" title="${creative.desire || ''}">${creative.desire || '-'}</span>
            </td>
            <td>
                <span class="text-truncate d-inline-block small" style="max-width: 60px;" title="${creative.benefit_focus || ''}">${creative.benefit_focus || '-'}</span>
            </td>
            <td>
                <span class="text-truncate d-inline-block small" style="max-width: 60px;" title="${creative.objections || ''}">${creative.objections || '-'}</span>
            </td>
            <td>
                <span class="text-truncate d-inline-block small" style="max-width: 60px;" title="${creative.persona || ''}">${creative.persona || '-'}</span>
            </td>
            <td>
                <span class="text-truncate d-inline-block small" style="max-width: 70px;" title="${creative.positioning_concept || ''}">${creative.positioning_concept || '-'}</span>
            </td>
            <td>
                <span class="text-truncate d-inline-block small" style="max-width: 60px;" title="${creative.hook_pattern || ''}">${creative.hook_pattern || '-'}</span>
            </td>
            <td>
                <span class="text-truncate d-inline-block small" style="max-width: 60px;" title="${creative.results || ''}">${creative.results || '-'}</span>
            </td>
            <td>
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="mdi mdi-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="editCreative('${creative.id}')">
                            <i class="mdi mdi-pencil me-2"></i>Edit
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="viewCreativeDetails('${creative.id}')">
                            <i class="mdi mdi-eye me-2"></i>View Details
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteCreative('${creative.id}')">
                            <i class="mdi mdi-delete me-2"></i>Delete
                        </a></li>
                    </ul>
                </div>
            </td>
        </tr>
    `).join('');
}

// Get status badge class
function getStatusBadge(status) {
    switch (status) {
        case 'Planning': return 'bg-secondary';
        case 'In Progress': return 'bg-warning';
        case 'Testing': return 'bg-info';
        case 'Completed': return 'bg-success';
        default: return 'bg-secondary';
    }
}

// Update filters
function updateFilters() {
    const brands = [...new Set(allCreatives.map(c => c.brand).filter(Boolean))];
    const brandFilter = document.getElementById('brandFilter');
    
    brandFilter.innerHTML = '<option value="">All Brands</option>' + 
        brands.map(brand => `<option value="${brand}">${brand}</option>`).join('');
}

// Setup event listeners
function setupEventListeners() {
    // Add creative form
    document.getElementById('addCreativeForm').addEventListener('submit', handleAddCreative);
    
    // Edit creative form
    document.getElementById('editCreativeForm').addEventListener('submit', handleEditCreative);
    
    // Filters
    document.getElementById('statusFilter').addEventListener('change', applyFilters);
    document.getElementById('adTypeFilter').addEventListener('change', applyFilters);
    document.getElementById('brandFilter').addEventListener('change', applyFilters);
    document.getElementById('searchCreatives').addEventListener('input', applyFilters);
    
    // Select all checkbox
    document.getElementById('selectAll').addEventListener('change', handleSelectAll);
    
    // Creative checkboxes
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('creative-checkbox')) {
            updateBulkActions();
        }
    });
}

// Update bulk actions
function updateBulkActions() {
    const checkboxes = document.querySelectorAll('.creative-checkbox:checked');
    const bulkActions = document.getElementById('bulkActions');
    
    if (checkboxes.length > 0) {
        bulkActions.classList.remove('d-none');
    } else {
        bulkActions.classList.add('d-none');
    }
}

// Initialize filters and search
document.getElementById('statusFilter').addEventListener('change', filterCreatives);
document.getElementById('adTypeFilter').addEventListener('change', filterCreatives);
document.getElementById('brandFilter').addEventListener('change', filterCreatives);
document.getElementById('searchCreatives').addEventListener('input', filterCreatives);

function filterCreatives() {
    const statusFilter = document.getElementById('statusFilter').value;
    const typeFilter = document.getElementById('adTypeFilter').value;
    const brandFilter = document.getElementById('brandFilter').value;
    const searchTerm = document.getElementById('searchCreatives').value.toLowerCase();
    
    let filtered = allCreatives.filter(creative => {
        const matchesStatus = !statusFilter || creative.status === statusFilter;
        const matchesType = !typeFilter || creative.ad_type === typeFilter;
        const matchesBrand = !brandFilter || creative.brand === brandFilter;
        const matchesSearch = !searchTerm || 
            creative.batch?.toLowerCase().includes(searchTerm) ||
            creative.brand?.toLowerCase().includes(searchTerm) ||
            creative.ad_concept?.toLowerCase().includes(searchTerm);
        
        return matchesStatus && matchesType && matchesBrand && matchesSearch;
    });
    
    renderCreatives(filtered);
}

// Add creative handler is set up in setupEventListeners() - removed duplicate

// Show/hide button loading
function showButtonLoading(textId, spinnerId) {
    document.getElementById(textId).classList.add('d-none');
    document.getElementById(spinnerId).classList.remove('d-none');
}

function hideButtonLoading(textId, spinnerId, originalText) {
    document.getElementById(textId).classList.remove('d-none');
    document.getElementById(textId).textContent = originalText;
    document.getElementById(spinnerId).classList.add('d-none');
}

// Success/error messages
function showSuccess(message) {
    // Implementation similar to tasks page
    console.log('Success:', message);
}

function showError(message) {
    // Implementation similar to tasks page
    console.log('Error:', message);
}

// Initialize project context
document.addEventListener('DOMContentLoaded', function() {
    projectId = getProjectIdFromURL();
    
    if (projectId) {
        document.getElementById('back-button-container').style.display = 'block';
        
        // Project context will be handled by the project switcher
        // No need to fetch projects array here since we're already in project context
        
        loadCreatives();
    } else {
        document.getElementById('projectContext').textContent = 'No project selected';
    }
});

// Checkbox handling
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('creative-checkbox') || e.target.id === 'selectAll') {
        updateBulkActions();
    }
});

// Multi-step modal functionality
let currentStep = 1;
const totalSteps = 3;

function showStep(step) {
    // Hide all steps
    document.querySelectorAll('.step-content').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.step-item').forEach(el => {
        el.classList.remove('active', 'completed');
    });
    document.querySelectorAll('.step-line').forEach(el => {
        el.classList.remove('completed');
    });
    
    // Show current step
    document.getElementById(`step${step}`).style.display = 'block';
    
    // Update step indicators
    for (let i = 1; i <= totalSteps; i++) {
        const stepItem = document.querySelector(`.step-item[data-step="${i}"]`);
        if (i < step) {
            stepItem.classList.add('completed');
        } else if (i === step) {
            stepItem.classList.add('active');
        }
    }
    
    // Update step lines
    for (let i = 1; i < totalSteps; i++) {
        const stepLine = document.querySelectorAll('.step-line')[i - 1];
        if (i < step) {
            stepLine.classList.add('completed');
        }
    }
    
    // Update buttons
    const prevBtn = document.getElementById('prevStep');
    const nextBtn = document.getElementById('nextStep');
    const submitBtn = document.getElementById('submitCreative');
    
    if (step === 1) {
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'inline-block';
        submitBtn.style.display = 'none';
    } else if (step === totalSteps) {
        prevBtn.style.display = 'inline-block';
        nextBtn.style.display = 'none';
        submitBtn.style.display = 'inline-block';
    } else {
        prevBtn.style.display = 'inline-block';
        nextBtn.style.display = 'inline-block';
        submitBtn.style.display = 'none';
    }
}

// Step navigation
document.getElementById('nextStep').addEventListener('click', function() {
    if (currentStep < totalSteps) {
        currentStep++;
        showStep(currentStep);
    }
});

document.getElementById('prevStep').addEventListener('click', function() {
    if (currentStep > 1) {
        currentStep--;
        showStep(currentStep);
    }
});

// Reset modal when closed
document.getElementById('addCreativeModal').addEventListener('hidden.bs.modal', function() {
    currentStep = 1;
    showStep(1);
    document.getElementById('addCreativeForm').reset();
});

// Custom styles for step indicators
const stepStyles = `
<style>
.step-progress-container {
    padding: 0 1rem;
}

.step-progress {
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

.step-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    flex: 0 0 auto;
}

.step-circle {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #e5e7eb;
    color: #6b7280;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.875rem;
    transition: all 0.3s ease;
    border: 2px solid #e5e7eb;
}

.step-item.active .step-circle {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
}

.step-item.completed .step-circle {
    background: #10b981;
    color: white;
    border-color: #10b981;
}

.step-label {
    margin-top: 0.5rem;
    font-size: 0.75rem;
    font-weight: 500;
    color: #6b7280;
    text-align: center;
    white-space: nowrap;
    transition: all 0.3s ease;
}

.step-item.active .step-label {
    color: #3b82f6;
    font-weight: 600;
}

.step-item.completed .step-label {
    color: #10b981;
}

.step-line {
    flex: 1;
    height: 2px;
    background: #e5e7eb;
    margin: 0 1rem;
    position: relative;
    top: -8px;
    transition: all 0.3s ease;
}

.step-line.completed {
    background: #10b981;
}

.step-content {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateX(20px); }
    to { opacity: 1; transform: translateX(0); }
}
</style>
`;

document.head.insertAdjacentHTML('beforeend', stepStyles);

// Handle add creative
async function handleAddCreative(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const creativeData = Object.fromEntries(formData.entries());
    
    try {
        const response = await fetch(`/api/projects/${projectId}/creatives`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(creativeData)
        });

        if (!response.ok) {
            throw new Error('Failed to create creative');
        }

        // Reload creatives
        await loadCreatives();
        
        // Close modal and reset form
        bootstrap.Modal.getInstance(document.getElementById('addCreativeModal')).hide();
        e.target.reset();
        
        showSuccess('Creative created successfully!');
    } catch (error) {
        console.error('Error creating creative:', error);
        showError('Failed to create creative');
    }
}

// Edit creative
function editCreative(id) {
    const creative = allCreatives.find(c => c.id === id);
    if (!creative) return;
    
    // Store the creative ID for the form submission
    currentEditId = id;
    
    // Populate edit form
    document.getElementById('editBatchNumber').value = creative.batch_number || '';
    document.getElementById('editBrand').value = creative.brand || '';
    document.getElementById('editStatus').value = creative.status || '';
    document.getElementById('editLaunchDate').value = creative.launch_date || '';
    document.getElementById('editAdConcept').value = creative.ad_concept || '';
    document.getElementById('editAdType').value = creative.ad_type || '';
    document.getElementById('editAdVariable').value = creative.ad_variable || '';
    document.getElementById('editDesire').value = creative.desire || '';
    document.getElementById('editBenefitFocus').value = creative.benefit_focus || '';
    document.getElementById('editObjections').value = creative.objections || '';
    document.getElementById('editPersona').value = creative.persona || '';
    document.getElementById('editPositioningConcept').value = creative.positioning_concept || '';
    document.getElementById('editPositioningHow').value = creative.positioning_how || '';
    document.getElementById('editHookPattern').value = creative.hook_pattern || '';
    document.getElementById('editResults').value = creative.results || '';
    document.getElementById('editWinningAds').value = creative.winning_ads || '';
    document.getElementById('editBriefLink').value = creative.brief_link || '';
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('editCreativeModal'));
    modal.show();
}

// Handle edit creative
async function handleEditCreative(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const creativeData = Object.fromEntries(formData.entries());
    
    try {
        const response = await fetch(`/api/projects/${projectId}/creatives/${currentEditId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(creativeData)
        });

        if (!response.ok) {
            throw new Error('Failed to update creative');
        }

        // Reload creatives
        await loadCreatives();
        
        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('editCreativeModal')).hide();
        
        showSuccess('Creative updated successfully!');
    } catch (error) {
        console.error('Error updating creative:', error);
        showError('Failed to update creative');
    }
}

// Apply filters
function applyFilters() {
    const statusFilter = document.getElementById('statusFilter').value;
    const adTypeFilter = document.getElementById('adTypeFilter').value;
    const brandFilter = document.getElementById('brandFilter').value;
    const searchTerm = document.getElementById('searchCreatives').value.toLowerCase();
    
    const filteredCreatives = allCreatives.filter(creative => {
        const matchesStatus = !statusFilter || creative.status === statusFilter;
        const matchesType = !adTypeFilter || creative.ad_type === adTypeFilter;
        const matchesBrand = !brandFilter || creative.brand === brandFilter;
        const matchesSearch = !searchTerm || 
            creative.brand?.toLowerCase().includes(searchTerm) ||
            creative.ad_concept?.toLowerCase().includes(searchTerm) ||
            creative.batch_number?.toLowerCase().includes(searchTerm);
        
        return matchesStatus && matchesType && matchesBrand && matchesSearch;
    });
    
    renderCreatives(filteredCreatives);
}

// Handle select all
function handleSelectAll(e) {
    const checkboxes = document.querySelectorAll('.creative-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = e.target.checked;
    });
    updateBulkActions();
}

// Utility functions
function showSuccess(message) {
    if (window.toast && window.toast.success) {
        window.toast.success(message);
    } else {
        // console.log('Success:', message);
        // Fallback to browser alert if toast is not available
        // alert(message);
    }
}

function showError(message) {
    if (window.toast) {
        window.toast.error(message);
    } else {
        // console.log('Error:', message);
    }
}

// View creative details
function viewCreativeDetails(id) {
    const creative = allCreatives.find(c => c.id === id);
    if (!creative) return;
    
    // Populate modal with creative data
    document.getElementById('viewCreativeBatch').textContent = creative.batch_number || 'N/A';
    document.getElementById('viewCreativeBrand').textContent = creative.brand || 'N/A';
    document.getElementById('viewCreativeStatus').textContent = creative.status || 'N/A';
    document.getElementById('viewCreativeAdConcept').textContent = creative.ad_concept || 'N/A';
    document.getElementById('viewCreativePersona').textContent = creative.persona || 'N/A';
    document.getElementById('viewCreativePositioningConcept').textContent = creative.positioning_concept || 'N/A';
    document.getElementById('viewCreativeHookPattern').textContent = creative.hook_pattern || 'N/A';
    document.getElementById('viewCreativeBriefLink').textContent = creative.brief_link || 'N/A';
    document.getElementById('viewCreativePositioningHow').textContent = creative.positioning_how || 'N/A';
    document.getElementById('viewCreativeResults').textContent = creative.results || 'N/A';
    document.getElementById('viewCreativeWinningAds').textContent = creative.winning_ads || 'N/A';
    
    // Store creative ID for potential edit action
    document.getElementById('viewCreativeModal').dataset.creativeId = id;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('viewCreativeModal'));
    modal.show();
}

// Edit creative from view modal
function editCreativeFromView() {
    const viewModal = bootstrap.Modal.getInstance(document.getElementById('viewCreativeModal'));
    const creativeId = document.getElementById('viewCreativeModal').dataset.creativeId;
    
    if (viewModal) {
        viewModal.hide();
    }
    
    // Wait for view modal to close, then open edit modal
    setTimeout(() => {
        editCreative(creativeId);
    }, 300);
}

// Delete creative
let deleteCreativeId = null;

function deleteCreative(id) {
    const creative = allCreatives.find(c => c.id === id);
    if (!creative) return;
    
    deleteCreativeId = id;
    document.getElementById('deleteCreativeName').textContent = `${creative.batch_number} - ${creative.brand}`;
    
    const modal = new bootstrap.Modal(document.getElementById('deleteCreativeModal'));
    modal.show();
}

// Confirm delete creative
async function confirmDeleteCreative() {
    if (!deleteCreativeId) return;
    
    try {
        const response = await fetch(`/api/projects/${projectId}/creatives/${deleteCreativeId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error('Failed to delete creative');
        }
        
        bootstrap.Modal.getInstance(document.getElementById('deleteCreativeModal')).hide();
        await loadCreatives();
        showSuccess('Creative deleted successfully!');
        
        deleteCreativeId = null;
    } catch (error) {
        console.error('Error deleting creative:', error);
        showError('Failed to delete creative');
    }
}

        // console.log('üé® Creative Tracker loaded!');
</script>

<%- contentFor('extra_javascript') %>